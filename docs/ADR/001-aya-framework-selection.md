# 架构决策记录：选择Aya框架作为eBPF运行时

## 状态

已接受

## 日期

2023-06-15

## 背景

AegisNet项目需要一个高效、可靠的eBPF运行时框架来实现网络流量监控和策略执行。我们需要在Rust生态系统中选择一个成熟的eBPF框架，以便与我们的Rust代码库无缝集成。

## 考虑的方案

1. **Aya框架**：纯Rust实现的eBPF库，专为安全性和可用性而设计
2. **libbpf-rs**：libbpf的Rust绑定，依赖于C库
3. **redbpf**：另一个Rust eBPF框架
4. **自行开发eBPF运行时**：从头开始构建自定义解决方案

## 决策

我们决定使用**Aya框架**作为AegisNet的eBPF运行时。

## 理由

- **纯Rust实现**：Aya是完全用Rust编写的，这与我们的技术栈完全一致，提供了类型安全和内存安全保证
- **活跃的社区**：Aya有一个活跃的开发社区，定期更新和改进
- **现代API设计**：提供了直观、类型安全的API，简化了eBPF程序的开发和加载
- **异步支持**：与Tokio等异步运行时良好集成，符合我们的异步架构设计
- **安全性**：强调安全性，减少了常见的eBPF编程错误
- **文档完善**：提供了全面的文档和示例，有助于团队快速上手

## 影响

- 所有eBPF相关代码将使用Aya框架开发
- 需要团队成员学习Aya的API和使用模式
- 可能需要为Aya框架贡献一些特定于我们用例的功能

## 替代方案

### libbpf-rs
- 优点：与Linux内核BPF子系统紧密集成
- 缺点：依赖C库，不是纯Rust实现，可能引入FFI相关问题

### redbpf
- 优点：纯Rust实现，专注于网络应用
- 缺点：社区较小，更新不如Aya频繁

### 自行开发
- 优点：完全控制实现细节，可以针对我们的需求优化
- 缺点：开发成本高，需要大量的内核和eBPF专业知识，维护负担重

## 相关决策

- 使用Tokio作为异步运行时
- 采用Rust作为主要开发语言

## 注释

我们将持续关注Aya框架的发展，并在必要时重新评估此决策。如果发现Aya在某些方面不能满足我们的需求，我们可能会考虑混合使用其他框架或贡献改进到Aya项目。